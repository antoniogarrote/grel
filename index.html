<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=640" />

    <link rel="stylesheet" href="stylesheets/core.css" media="screen"/>
    <link rel="stylesheet" href="stylesheets/mobile.css" media="handheld, only screen and (max-device-width:640px)"/>
    <link rel="stylesheet" href="stylesheets/pygment_trac.css"/>

    <script type="text/javascript" src="javascripts/modernizr.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="javascripts/headsmart.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function () {
        $('#main_content').headsmart()
      })
    </script>
    <title>Grel by antoniogarrote</title>
  </head>

  <body>
    <a id="forkme_banner" href="https://github.com/antoniogarrote/grel">View on GitHub</a>
    <div class="shell">

      <header>
        <span class="ribbon-outer">
          <span class="ribbon-inner">
            <h1>Grel</h1>
            <h2>Query and manipulation library of ruby objects in a  Stardog RDF graph</h2>
          </span>
          <span class="left-tail"></span>
          <span class="right-tail"></span>
        </span>
      </header>

      <section id="downloads">
        <span class="inner">
          <a href="https://github.com/antoniogarrote/grel/zipball/master" class="zip"><em>download</em> .ZIP</a><a href="https://github.com/antoniogarrote/grel/tarball/master" class="tgz"><em>download</em> .TGZ</a>
        </span>
      </section>


      <span class="banner-fix"></span>


      <section id="main_content">
        <h1>GRel</h1>

<p>A small ruby library that makes it easy to store and query ruby objects stored in the RDF database <a href="http://stardog.com/">Stardog</a>.</p>

<h2>Initialization</h2>

<div class="highlight"><pre>    <span class="nb">require</span> <span class="s1">'grel'</span>

    <span class="kp">include</span> <span class="no">GRel</span>

    <span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">with_db</span><span class="p">(</span><span class="no">DB</span><span class="p">)</span>
</pre></div>

<h2>Linking Data</h2>

<p>GRel works with graphs of linked Ruby hashes.
Evey hash in the graph will be identified by a special <em><a href="https://github.com/id" class="user-mention">@id</a></em> property. The value for the <em><a href="https://github.com/id" class="user-mention">@id</a></em> can be assigned when describing the object or it will be auto-generated by GRel if none is assigned.
To link two hashes by a property, the linked object with its corresponding <em><a href="https://github.com/id" class="user-mention">@id</a></em> value can be nested in the parent object or the value for the <em><a href="https://github.com/id" class="user-mention">@id</a></em> using the string literal "<a href="https://github.com/id" class="user-mention">@id</a>(value)" can be assigned directly.</p>

<p>This two queries are equivalent:</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span>     <span class="o">=&gt;</span> <span class="s1">'abs'</span><span class="p">,</span>
            <span class="ss">:name</span>    <span class="o">=&gt;</span> <span class="s1">'Abhinay'</span><span class="p">,</span>
            <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:@id</span>  <span class="o">=&gt;</span> <span class="s1">'in'</span><span class="p">,</span>
                         <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'India'</span><span class="p">})</span>
    <span class="c1"># abs -&gt; citizen -&gt; in</span>
</pre></div>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span>     <span class="o">=&gt;</span> <span class="s1">'abs'</span><span class="p">,</span>
            <span class="ss">:name</span>    <span class="o">=&gt;</span> <span class="s1">'Abhinay'</span><span class="p">,</span>
            <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="s1">'@id(in)'</span><span class="p">)</span>
    <span class="c1"># abs -&gt; citizen -&gt; in</span>
</pre></div>

<p>If a string literal is used but no '<a href="https://github.com/id" class="user-mention">@id</a>(value)' syntax is used not object will be linked but the literal value of the string will be assigned:</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span>     <span class="o">=&gt;</span> <span class="s1">'abs'</span><span class="p">,</span>
            <span class="ss">:name</span>    <span class="o">=&gt;</span> <span class="s1">'Abhinay'</span><span class="p">,</span>
            <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="s1">'in'</span><span class="p">)</span>
    <span class="c1"># abs has a citizen property with the literal value 'in'</span>
</pre></div>

<p>In the description of an object, the value for the <em><a href="https://github.com/id" class="user-mention">@id</a>' property can be specified using the *<a href="https://github.com/id" class="user-mention">@id</a>(value)</em> syntax or directly with the value.</p>

<p>This two queries are equivalent:</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span>     <span class="o">=&gt;</span> <span class="s1">'abs'</span><span class="p">,</span>
            <span class="ss">:name</span>    <span class="o">=&gt;</span> <span class="s1">'Abhinay'</span><span class="p">)</span>
</pre></div>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span>     <span class="o">=&gt;</span> <span class="s1">'@id(abs)'</span><span class="p">,</span>
            <span class="ss">:name</span>    <span class="o">=&gt;</span> <span class="s1">'Abhinay'</span><span class="p">)</span>
</pre></div>

<h2>Data loading:</h2>

<p>Data is loaded as arrays of nested hashes.
Two special properties <em>:<a href="https://github.com/id" class="user-mention">@id</a></em> and <em>:<a href="https://github.com/type" class="user-mention">@type</a></em> are used to identify the identity of the node and its types.
Identity must be unique, type can be multiple.
If no <em>:@id</em> property is provided for an object, an identity will be generated.</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:name</span>    <span class="o">=&gt;</span> <span class="s1">'Abhinay'</span><span class="p">,</span>
            <span class="ss">:surname</span> <span class="o">=&gt;</span> <span class="s1">'Mehta'</span><span class="p">,</span>
            <span class="ss">:@type</span>   <span class="o">=&gt;</span> <span class="ss">:Developer</span><span class="p">,</span>
            <span class="ss">:@id</span>     <span class="o">=&gt;</span> <span class="s1">'abs'</span><span class="p">)</span><span class="o">.</span>

      <span class="n">store</span><span class="p">(</span><span class="ss">:name</span>    <span class="o">=&gt;</span> <span class="s1">'Tom'</span><span class="p">,</span>
            <span class="ss">:surname</span> <span class="o">=&gt;</span> <span class="s1">'Hall'</span><span class="p">,</span>
            <span class="ss">:@type</span>   <span class="o">=&gt;</span> <span class="ss">:Developer</span><span class="p">,</span>
            <span class="ss">:@id</span>     <span class="o">=&gt;</span> <span class="s1">'thattommyhall'</span><span class="p">)</span><span class="o">.</span>

      <span class="n">store</span><span class="p">(</span><span class="ss">:name</span>       <span class="o">=&gt;</span> <span class="s1">'India'</span><span class="p">,</span>
            <span class="ss">:@type</span>      <span class="o">=&gt;</span> <span class="ss">:Country</span><span class="p">,</span>
            <span class="ss">:population</span> <span class="o">=&gt;</span> <span class="mi">1200</span><span class="p">,</span>
            <span class="ss">:capital</span>    <span class="o">=&gt;</span> <span class="s1">'New Delhi'</span><span class="p">,</span>
            <span class="ss">:@id</span>        <span class="o">=&gt;</span> <span class="s1">'in'</span><span class="p">)</span><span class="o">.</span>

      <span class="n">store</span><span class="p">(</span><span class="ss">:name</span>       <span class="o">=&gt;</span> <span class="s1">'United Kingdom'</span><span class="p">,</span>
            <span class="ss">:@type</span>      <span class="o">=&gt;</span> <span class="ss">:Country</span><span class="p">,</span>
            <span class="ss">:population</span> <span class="o">=&gt;</span> <span class="mi">62</span><span class="p">,</span>
            <span class="ss">:capital</span>    <span class="o">=&gt;</span> <span class="s1">'London'</span><span class="p">,</span>
            <span class="ss">:@id</span>        <span class="o">=&gt;</span> <span class="s1">'uk'</span><span class="p">)</span><span class="o">.</span>

      <span class="c1"># Storing relationships</span>
      <span class="n">store</span><span class="p">(</span><span class="ss">:@id</span>     <span class="o">=&gt;</span> <span class="s1">'abs'</span><span class="p">,</span>
            <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="s1">'@id(in)'</span><span class="p">)</span><span class="o">.</span>

      <span class="n">store</span><span class="p">(</span><span class="ss">:@id</span>     <span class="o">=&gt;</span> <span class="s1">'thattommyhall'</span><span class="p">,</span>
            <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="s1">'@id(uk)'</span><span class="p">)</span><span class="o">.</span>

      <span class="c1"># Storing nested objects</span>
      <span class="n">store</span><span class="p">(</span><span class="ss">:@id</span>     <span class="o">=&gt;</span> <span class="s1">'antoniogarrote'</span><span class="p">,</span>
            <span class="ss">:name</span>    <span class="o">=&gt;</span> <span class="s1">'Antonio'</span><span class="p">,</span>
            <span class="ss">:@type</span>   <span class="o">=&gt;</span> <span class="ss">:Developer</span><span class="p">,</span>
            <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:name</span>       <span class="o">=&gt;</span> <span class="s1">'Spain'</span><span class="p">,</span>
                         <span class="ss">:@type</span>      <span class="o">=&gt;</span> <span class="ss">:Country</span><span class="p">,</span>
                         <span class="ss">:population</span> <span class="o">=&gt;</span> <span class="mi">43</span><span class="p">,</span>
                         <span class="ss">:capital</span>    <span class="o">=&gt;</span> <span class="s1">'Madrid'</span><span class="p">,</span>
                         <span class="ss">:@id</span>        <span class="o">=&gt;</span> <span class="s1">'es'</span><span class="p">})</span>             
</pre></div>

<h2>Querying:</h2>

<p>Queries can be performed using the <em>where</em> and passing a hash with a pattern for the nodes to be retrieved, and chaining it with the <em>all</em> methods.</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Developer</span><span class="p">)</span><span class="o">.</span><span class="n">all</span> 
    <span class="c1"># [ {:@id =&gt; '@id(abs)', :name =&gt; 'Abhinay', :citizen =&gt; '@(in)'},</span>
    <span class="c1">#   {:@id =&gt; '@id(thattommyhall)', :name =&gt; 'Tom', :citizen =&gt; '@(uk)'},</span>
    <span class="c1">#   {:@id =&gt; '@id(antoniogarrote)', :name =&gt; 'Antonio', :citizen =&gt; '@(es)'} ]</span>
</pre></div>

<p>Nested objects can be retrieved specifying an empty hash for the property.
By default, the method <em>all</em> will return an array with all the objects in the recovered, including objects nested in other objects properties. 
If our query returns a graph with no cycles and we want to return only the top level objects that or not linked from other objects properties, we can pass the option <em>:unlinked =&gt; true</em> to the message.</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Developer</span><span class="p">,</span> <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="p">{})</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:unlinked</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
    <span class="c1"># [ {:@id =&gt; '@id(abs)', :name =&gt; 'Abhinay', ...</span>
    <span class="c1">#    :citizen =&gt; {:@id =&gt; '@(in)', :name =&gt; 'India', ... }},</span>
    <span class="c1">#   {:@id =&gt; '@id(thattommyhall)', :name =&gt; 'Tom', ...</span>
    <span class="c1">#    :citizen =&gt; {:@id =&gt; '@(uk)', :name =&gt; 'United Kingdom' ... }},</span>
    <span class="c1">#   {:@id =&gt; '@id(antoniogarrote)', :name =&gt; 'Antonio', ... </span>
    <span class="c1">#    :citizen =&gt; {:@id =&gt; '@(es)', :name =&gt; 'Spain', ... }} ]</span>
</pre></div>

<p>Relationships between objects can be specified in inverse order using a key starting with <em>$inv</em>.</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Country</span><span class="p">,</span> 
            <span class="p">:</span><span class="vg">$inv_citizen</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">"Abhinay"</span><span class="p">})</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:unlinked</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
    <span class="c1"># [ {:@id =&gt; '@id(in)', :name =&gt; 'India', ...'} ]</span>
</pre></div>

<p>Filters can be applied to properties to select valid objects:</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Country</span><span class="p">,</span> 
            <span class="ss">:population</span> <span class="o">=&gt;</span> <span class="p">{:</span><span class="vg">$gt</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">})</span><span class="o">.</span><span class="n">all</span>
    <span class="c1"># [ {:@id =&gt; '@id(in)', :name =&gt; 'India', :population =&gt; 1200, ...'} ]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Country</span><span class="p">,</span> 
            <span class="ss">:population</span> <span class="o">=&gt;</span> <span class="p">{:</span><span class="vg">$or</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="p">{:</span><span class="vg">$lt</span> <span class="o">=&gt;</span> <span class="mi">50</span><span class="p">},{:</span><span class="vg">$gt</span> <span class="o">=&gt;</span> <span class="mi">1000</span><span class="p">}</span><span class="o">]</span><span class="p">})</span><span class="o">.</span><span class="n">all</span>
    <span class="c1"># [ {:@id =&gt; '@id(in)', :name =&gt; 'India', :population =&gt; 1200, ...'},</span>
    <span class="c1">#   {:@id =&gt; '@id(es)', :name =&gt; 'Spain', :population =&gt; 43, ...} ]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Country</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="p">{:</span><span class="vg">$like</span> <span class="o">=&gt;</span> <span class="sr">/.+a.+/</span><span class="p">})</span><span class="o">.</span><span class="n">all</span>
    <span class="c1"># [ {:@id =&gt; '@id(es)', :name =&gt; 'Spain', :population =&gt; 43, ...} ]</span>
</pre></div>

<p>Valid filters are: <em>$and</em>, <em>$or</em>, <em>$lt</em>, <em>$lteq</em>, <em>$gt</em>, <em>$gteq</em>, <em>$eq</em>, <em>$in</em> and <em>$like</em>.</p>

<p>Different optional patterns can be joined in a single query using the method <em>union</em>.</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Country</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Developer</span><span class="p">)</span><span class="o">.</span><span class="n">all</span>
    <span class="c1"># returns all objects</span>
</pre></div>

<p>If more than one object matches a property, the final set of matching objects will be returned in an array.</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span>     <span class="o">=&gt;</span> <span class="s1">'abs'</span><span class="p">,</span>
            <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="s1">'@id(uk)'</span><span class="p">)</span><span class="o">.</span>

      <span class="n">where</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Abhinay'</span><span class="p">,</span> <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="p">{})</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:unlinked</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
    <span class="c1"># [ {:@id =&gt; '@id(abs)', :name =&gt; 'Abhinay', ...</span>
    <span class="c1">#    :citizen =&gt; [{:@id =&gt; '@(in)', :name =&gt; 'India', ... },</span>
    <span class="c1">#                 {:@id =&gt; '@(uk)', :name =&gt; 'United Kingdom', ..}]} ],</span>

</pre></div>

<h2>Removing data</h2>

<p>The message <em>remove</em> can be sent after running a query to remove the retrieved data from the graph:</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span>  <span class="o">=&gt;</span> <span class="s1">'abs'</span><span class="p">,</span>
            <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Abhinay'</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'abs'</span><span class="p">)</span><span class="o">.</span><span class="n">remove</span>
</pre></div>

<p>If particular properties from the graph need to be removed from the graph without running a query, the <em>remove</em> message can be send directly to the graph object.
This method is the opposite to an <em>store</em> operation.</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span>        <span class="o">=&gt;</span> <span class="s1">'es'</span><span class="p">,</span>
            <span class="ss">:name</span>       <span class="o">=&gt;</span> <span class="s1">'Spain'</span><span class="p">,</span>
            <span class="ss">:population</span> <span class="o">=&gt;</span> <span class="mi">43</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'es'</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="c1"># {:@id =&gt; '@id(es), :name =&gt; 'Spain', :population =&gt; 43}</span>

    <span class="n">g</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'es'</span><span class="p">,</span> <span class="ss">:population</span> <span class="o">=&gt;</span> <span class="mi">43</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'es'</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="c1"># {:@id =&gt; '@id(es), :name =&gt; 'Spain'}</span>
</pre></div>

<h2>Tuple Queries</h2>

<p>Sometimes we just want to retrieve particular facts from the data graph instead of full nodes. Tuple queries makes it possible to retrieve elements of a graph pattern matching the data graph. 
Results will be returned as hashes where each property is one of the variables in the graph pattern.</p>

<p>Tuple variables are defined in the query as symbols starting by an underscore <em>:_variable_name</em>:</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="ss">:_id</span><span class="p">,</span> 
            <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="ss">:_first_name</span><span class="p">,</span> 
            <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Spain'</span><span class="p">,</span> 
                          <span class="ss">:capital</span> <span class="o">=&gt;</span> <span class="ss">:_capital</span> <span class="p">})</span><span class="o">.</span><span class="n">tuples</span>
    <span class="c1"># [ {:id =&gt; '@id(antoniogarrote)', </span>
    <span class="c1">#    :first_name =&gt; 'Antonio', </span>
    <span class="c1">#    :capital =&gt; 'Madrid} ]</span>

    <span class="c1"># variables can also be added into properties not only values</span>
    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:_property</span> <span class="o">=&gt;</span> <span class="s2">"Antonio"</span><span class="p">)</span><span class="o">.</span><span class="n">tuples</span>
    <span class="c1"># [ {:property =&gt; :name} ]</span>
</pre></div>

<h2>Inference</h2>

<p>Schema information can be added using the <em>define</em> method and assertions like <em>@subclass</em>, <em>@subproperty</em>, <em>@domain</em>, <em>@range</em>.</p>

<div class="highlight"><pre>    <span class="c1"># All developers are People</span>
    <span class="n">g</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="ss">:Developer</span><span class="p">,</span> <span class="ss">:@subclass</span><span class="p">,</span> <span class="ss">:Person</span><span class="p">)</span>   
</pre></div>

<p>If inference is enabled for a connection using the <em>with_reasoning</em> method, queries will return additional results.</p>

<div class="highlight"><pre>    <span class="c1"># No reasoning</span>
    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Person</span><span class="p">)</span><span class="o">.</span><span class="n">all</span>
    <span class="c1"># []</span>

    <span class="c1"># With reasoning</span>
    <span class="n">g</span><span class="o">.</span><span class="n">with_reasoning</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Person</span><span class="p">)</span><span class="o">.</span><span class="n">all</span>
    <span class="c1"># [{:@id =&gt; 'id(abs)', </span>
    <span class="c1">#   :@type =&gt; :Developer, ...},</span>
    <span class="c1">#  {:@id =&gt; 'id(thattommyhall)', </span>
    <span class="c1">#   :@type =&gt; :Developer, ...},</span>
    <span class="c1">#  {:@id =&gt; 'id(antoniogarrote)', </span>
    <span class="c1">#   :@type =&gt; :Developer, ...}]</span>
</pre></div>

<p>An example using the <em>@subproperty</em> declaration.</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="ss">:citizen</span><span class="p">,</span> <span class="ss">:@subproperty</span><span class="p">,</span> <span class="ss">:bornin</span><span class="p">)</span>   

    <span class="n">g</span><span class="o">.</span><span class="n">with_reasoning</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:bornin</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Country</span><span class="p">,</span> 
                                       <span class="ss">:capital</span> <span class="o">=&gt;</span> <span class="s1">'Madrid'</span><span class="p">})</span><span class="o">.</span><span class="n">all</span>
    <span class="c1"># [{:@id =&gt; 'id(antoniogarrote)', </span>
    <span class="c1">#   :citizen =&gt; {:@id =&gt; 'id(es)', </span>
    <span class="c1">#                :capital =&gt; 'Madrid', ... }, ...}]</span>
</pre></div>

<p>An example using the <em>@domain</em> and <em>@range</em> declarations.</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="ss">:citizen</span><span class="p">,</span> <span class="ss">:@domain</span><span class="p">,</span> <span class="ss">:Citizen</span><span class="p">)</span>   
    <span class="n">g</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="ss">:citizen</span><span class="p">,</span> <span class="ss">:@range</span><span class="p">,</span> <span class="ss">:State</span><span class="p">)</span>   

    <span class="n">g</span><span class="o">.</span><span class="n">with_reasoning</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Citizen</span><span class="p">,</span> 
                           <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:State</span><span class="p">})</span><span class="o">.</span><span class="n">all</span>
    <span class="c1"># [{:@id =&gt; 'id(antoniogarrote)', </span>
    <span class="c1">#   :citizen =&gt; {:@id =&gt; 'id(es)', </span>
    <span class="c1">#                :capital =&gt; 'Madrid', ... }, ...},</span>
    <span class="c1">#  {:@id =&gt; 'id(thattommyhall)',  </span>
    <span class="c1">#   :citizen =&gt; {:@id =&gt; 'id(uk)', </span>
    <span class="c1">#                :capital =&gt; 'Madrid', ... }, ...}</span>
    <span class="c1">#  ... ]</span>
</pre></div>

<p>Schema definitions can be removed using the method <em>retract_definition</em>.</p>

<p>An example using the <em>@domain</em> and <em>@range</em> declarations.</p>

<div class="highlight"><pre>    <span class="n">g</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="ss">:citizen</span><span class="p">,</span> <span class="ss">:@domain</span><span class="p">,</span> <span class="ss">:Citizen</span><span class="p">)</span>   
    <span class="n">g</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="ss">:citizen</span><span class="p">,</span> <span class="ss">:@range</span><span class="p">,</span> <span class="ss">:State</span><span class="p">)</span>   

    <span class="n">g</span><span class="o">.</span><span class="n">with_reasoning</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Citizen</span><span class="p">,</span> 
                           <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:State</span><span class="p">})</span><span class="o">.</span><span class="n">all</span>
    <span class="c1"># [{:@id =&gt; 'id(antoniogarrote)', </span>
    <span class="c1">#   :citizen =&gt; {:@id =&gt; 'id(es)', </span>
    <span class="c1">#                :capital =&gt; 'Madrid', ... }, ...},</span>
    <span class="c1">#  {:@id =&gt; 'id(thattommyhall)',  </span>
    <span class="c1">#   :citizen =&gt; {:@id =&gt; 'id(uk)', </span>
    <span class="c1">#                :capital =&gt; 'Madrid', ... }, ...}</span>
    <span class="c1">#  ... ]</span>

    <span class="n">g</span><span class="o">.</span><span class="n">retract_definition</span><span class="p">(</span><span class="ss">:citizen</span><span class="p">,</span> <span class="ss">:@range</span><span class="p">,</span> <span class="ss">:State</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Citizen</span><span class="p">,</span> <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:State</span><span class="p">})</span><span class="o">.</span><span class="n">all</span>
    <span class="c1"># [ ]</span>
</pre></div>

<p>Inference can be disabled sending the <em>without_reasoning</em> message.</p>

<h2>Validations</h2>

<p>Reasoning support can also be used to validate the objects you insert in the graph. In this case, your schema definitions are interpreted not to infere new knowledge but to check that the structure of the objects inserted match the schema.</p>

<p>Validations can be introduced in the graph using the <em>validate</em> message that receives an assertion with the <em>@subclass</em>, <em>@subproperty</em>, <em>@domain</em> or <em>@range</em> properties.</p>

<p>Validations are turned on/off using the <em>with_validations</em> and <em>without_validations</em> messages.</p>

<p>If a validation is violated, an exception will be raised. If validations are turned on and there's already invalid data in the graph, no further insertions will succeed.</p>

<p>Validations can also be removed using the <em>retract_validation</em> message.</p>

<div class="highlight"><pre>    <span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">with_db</span><span class="p">(</span><span class="no">DB</span><span class="p">)</span> <span class="c1"># new graph</span>

    <span class="n">g</span><span class="o">.</span><span class="n">with_validations</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="ss">:citizen</span><span class="p">,</span> <span class="ss">:@domain</span><span class="p">,</span> <span class="ss">:State</span><span class="p">)</span>   

    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'id(malditogeek)'</span><span class="p">,</span> 
            <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'id(ar)'</span><span class="p">,</span> 
                         <span class="ss">:capital</span> <span class="o">=&gt;</span> <span class="s1">'Buenos Aires'</span><span class="p">},</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>

    <span class="c1"># An exception is raised due to validation violation</span>

    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'ar'</span><span class="p">,</span> 
            <span class="ss">:capital</span> <span class="o">=&gt;</span> <span class="s1">'Buenos Aires'</span><span class="p">,</span> 
            <span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:State</span><span class="p">,</span> 
            <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Argentina'</span><span class="p">)</span><span class="o">.</span>
      <span class="n">store</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'id(malditogeek)'</span><span class="p">,</span> 
            <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="s1">'@id(ar)'</span><span class="p">)</span>
    <span class="c1"># After adding the @type for Argentina, the insertion does not raise any exception.</span>
</pre></div>

<p>Validations and inference can be used together to infere additional infromation that will make data valid according to the defined validations:</p>

<div class="highlight"><pre>    <span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">with_db</span><span class="p">(</span><span class="no">DB</span><span class="p">)</span> <span class="c1"># new graph</span>

    <span class="n">g</span><span class="o">.</span><span class="n">with_validations</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="ss">:citizen</span><span class="p">,</span> <span class="ss">:@domain</span><span class="p">,</span> <span class="ss">:State</span><span class="p">)</span>   

    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'id(malditogeek)'</span><span class="p">,</span> 
            <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'id(ar)'</span><span class="p">,</span> 
                         <span class="ss">:capital</span> <span class="o">=&gt;</span> <span class="s1">'Buenos Aires'</span><span class="p">},</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>

    <span class="c1"># An exception is raised due to validation violation</span>

    <span class="n">g</span><span class="o">.</span><span class="n">with_reasoning</span><span class="o">.</span><span class="n">define</span><span class="p">(</span><span class="ss">:citizen</span><span class="p">,</span> <span class="ss">:@domain</span><span class="p">,</span> <span class="ss">:State</span><span class="p">)</span><span class="o">.</span>
      <span class="n">store</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'id(malditogeek)'</span><span class="p">,</span> 
            <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'id(ar)'</span><span class="p">,</span> 
                         <span class="ss">:capital</span> <span class="o">=&gt;</span> <span class="s1">'Buenos Aires'</span><span class="p">},</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
    <span class="c1"># Data is valid using reasoning since the @type :State for Argentina can be inferred.</span>

    <span class="n">g</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Citizen</span><span class="p">,</span> 
            <span class="ss">:citizen</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:State</span><span class="p">})</span><span class="o">.</span><span class="n">all</span>
    <span class="c1"># [{:@id =&gt; 'id(malditogeek)', </span>
    <span class="c1">#   :citizen =&gt; {:@id =&gt; 'id(ar)', </span>
    <span class="c1">#                :capital =&gt; 'Buenos Aires', ... }, ...}]</span>

    <span class="n">g</span><span class="o">.</span><span class="n">without_reasoning</span> <span class="c1"># graph is invalid now, no further operations can be committed.</span>

    <span class="n">g</span><span class="o">.</span><span class="n">without_validations</span> <span class="c1"># graph is again valid since no validations will be checked.</span>
</pre></div>

<p>Some examples of validations are:</p>

<ul>
<li>Data types in range, using the corresponding class <em>Date</em>, <em>Float</em>, <em>Fixnum</em>, <em>TrueClass</em> / <em>FalseClass</em>:</li>
</ul><div class="highlight"><pre>    <span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">with_db</span><span class="p">(</span><span class="no">DB</span><span class="p">)</span> <span class="c1"># new graph</span>

    <span class="n">g</span><span class="o">.</span><span class="n">with_validations</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="ss">:born</span><span class="p">,</span> <span class="ss">:@domain</span><span class="p">,</span> <span class="no">Date</span><span class="p">)</span> <span class="c1"># born must have a Date value</span>

    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'antoniogarrote'</span><span class="p">,</span> <span class="ss">:born</span> <span class="o">=&gt;</span> <span class="s2">"1982-05-01"</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>

    <span class="c1"># An exception is raised due to validation violation, :born has a string value not a date vaue</span>

    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'antoniogarrote'</span><span class="p">,</span> <span class="ss">:born</span> <span class="o">=&gt;</span> <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">"1982-05-01"</span><span class="p">),</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>

    <span class="c1"># No validation error is raised</span>
</pre></div>

<ul>
<li>Subclass / Superclass relationships</li>
</ul><div class="highlight"><pre>    <span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">with_db</span><span class="p">(</span><span class="no">DB</span><span class="p">)</span> <span class="c1"># new graph</span>

    <span class="n">g</span><span class="o">.</span><span class="n">with_validations</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="ss">:Developer</span><span class="p">,</span> <span class="ss">:@subclass</span><span class="p">,</span> <span class="ss">:Person</span><span class="p">)</span> <span class="c1"># all Developers must be human!</span>

    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'abhinay'</span><span class="p">,</span> <span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Developer</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>

    <span class="c1"># An exception is raised due to validation violation, :Person @type is missing</span>

    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'abhinay'</span><span class="p">,</span> <span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:Developer</span><span class="p">,</span> <span class="ss">:Person</span><span class="o">]</span><span class="p">,</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>

    <span class="c1"># No validation error is raised</span>
</pre></div>

<ul>
<li>Participation constraints</li>
</ul><div class="highlight"><pre>    <span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">with_db</span><span class="p">(</span><span class="no">DB</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">with_validations</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="ss">:Supervisor</span><span class="p">,</span> <span class="ss">:@some</span><span class="p">,</span> <span class="o">[</span><span class="ss">:supervises</span><span class="p">,</span> <span class="ss">:Employee</span><span class="o">]</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@type</span>  <span class="o">=&gt;</span> <span class="ss">:Supervisor</span><span class="p">)</span>

    <span class="c1"># An exception is raised, Supervisors must supervise employees</span>

    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@type</span>  <span class="o">=&gt;</span> <span class="ss">:Supervisor</span><span class="p">,</span> <span class="ss">:supervises</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Employee</span><span class="p">})</span>

    <span class="c1"># No validation error is raised</span>
</pre></div>

<div class="highlight"><pre>    <span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">with_db</span><span class="p">(</span><span class="no">DB</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">with_validations</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="ss">:Supervisor</span><span class="p">,</span> <span class="ss">:@all</span><span class="p">,</span> <span class="o">[</span><span class="ss">:supervises</span><span class="p">,</span> <span class="ss">:Employee</span><span class="o">]</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@type</span>  <span class="o">=&gt;</span> <span class="ss">:Supervisor</span><span class="p">,</span> 
            <span class="ss">:supervises</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="p">{</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'a'</span><span class="p">,</span> <span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Employee</span><span class="p">},</span>
                            <span class="p">{</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'b'</span><span class="p">,</span> <span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Assistant</span><span class="p">}</span><span class="o">]</span><span class="p">)</span>

    <span class="c1"># An exception is raised, all objectes supervised by a Supervisor must belong to</span>
    <span class="c1"># the Employee class</span>

    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@type</span>  <span class="o">=&gt;</span> <span class="ss">:Supervisor</span><span class="p">,</span> 
            <span class="ss">:supervises</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="p">{</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'a'</span><span class="p">,</span> <span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Employee</span><span class="p">},</span>
                            <span class="p">{</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'b'</span><span class="p">,</span> <span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:Assistant</span><span class="p">,</span> <span class="ss">:Employee</span><span class="o">]</span><span class="p">}</span><span class="o">]</span><span class="p">)</span>


    <span class="c1"># No validation error is raised</span>
</pre></div>

<ul>
<li>Cardinality constraints</li>
</ul><div class="highlight"><pre>    <span class="n">g</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">with_db</span><span class="p">(</span><span class="no">DB</span><span class="p">)</span><span class="o">.</span><span class="n">with_validations</span>

    <span class="n">g</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="ss">:Person</span><span class="p">,</span> <span class="ss">:@cardinality</span><span class="p">,</span> <span class="p">{</span><span class="ss">:property</span> <span class="o">=&gt;</span> <span class="ss">:lives</span><span class="p">,</span> 
                                        <span class="ss">:max</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> 
                                        <span class="ss">:min</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">})</span>

    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Person</span><span class="p">,</span>
            <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Antonio'</span><span class="p">,</span>
            <span class="ss">:lives</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="p">{</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'es'</span><span class="p">},{</span><span class="ss">:@id</span> <span class="o">=&gt;</span> <span class="s1">'uk'</span><span class="p">}</span><span class="o">]</span><span class="p">)</span>


    <span class="c1"># An exception is raised, People can only live in one place</span>

    <span class="n">g</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="ss">:@type</span> <span class="o">=&gt;</span> <span class="ss">:Person</span><span class="p">,</span>
            <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Antonio'</span><span class="p">,</span>
            <span class="ss">:lives</span> <span class="o">=&gt;</span> <span class="s1">'@id(uk)'</span><span class="p">)</span>

    <span class="c1"># No validation error is raised</span>
</pre></div>

<p>The details about how to use validations can be found in the Stardog documentation related to ICV (Integrity Constraints Validations) for the data base (<a href="http://stardog.com/docs/sdp/#validation">http://stardog.com/docs/sdp/#validation</a>).</p>

<h2>License</h2>

<p>Licensed under the Apache2 license.</p>

<h2>Author and contact:</h2>

<p>Antonio Garrote (<a href="mailto:antoniogarrote@gmail.com">antoniogarrote@gmail.com</a>)</p>
      </section>

      <footer>
        <span class="ribbon-outer">
          <span class="ribbon-inner">
            <p>this project by <a href="https://github.com/antoniogarrote">antoniogarrote</a> can be found on <a href="https://github.com/antoniogarrote/grel">GitHub</a></p>
          </span>
          <span class="left-tail"></span>
          <span class="right-tail"></span>
        </span>
        <p>Generated with <a href="http://pages.github.com">GitHub Pages</a> using Merlot</p>
        <span class="octocat"></span>
      </footer>

    </div>

              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-39541845-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
